<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fitness Chatbot</title>
  <link rel="stylesheet" href="base.css" />
</head>
<body class="body">
  <div class="container">
    <div class="chatbox">
        <div class="chatbox__support">
            <div class="chatbox__header">
                <div class="chatbox__image--header">
                    <img src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-5--v1.png" alt="image">
                </div>
                <div class="chatbox__content--header">
                    <h4 class="chatbox__heading--header" id="fitness-chatbot">Fitness Chatbot</h4>
                </div>
            </div>
            <div class="chatbox__messages" id="chatboxMessages">
                <div></div>
            </div>
            <div class="chatbox__footer">
                <input type="text" id="userInput" placeholder="Write a message...">
                <button class="chatbox__send--footer" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div class="chatbox__button">
            <button><img class="chimg" src="chatbox-icon.svg" alt="chatbox icon" /></button>
        </div>
    </div>
  </div>

  <script>
    async function sendMessage() {
      const userInput = document.getElementById('userInput').value;
      if (userInput.trim() === "") return;

      // Display user message
      appendMessage(userInput, 'user');

      try {
        // Send message to Rasa bot
        const response = await fetch('http://localhost:5005/webhooks/rest/webhook', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sender: 'user', message: userInput })
        });

        if (!response.ok) {
          throw new Error('Network response was not ok ' + response.statusText);
        }

        const data = await response.json();

        // Display bot response
        data.forEach(message => {
          appendMessage(message.text, 'bot');
        });

      } catch (error) {
        console.error('Fetch error: ', error);
        appendMessage('Sorry, I am unable to connect to the server at the moment.', 'bot');
      }

      // Clear input field
      document.getElementById('userInput').value = '';
    }

    function appendMessage(message, sender) {
      const messagesContainer = document.getElementById('chatboxMessages');
      const messageElement = document.createElement('div');
      messageElement.classList.add(sender === 'user' ? 'chatbox__message--user' : 'chatbox__message--bot');
      
      // Replace newlines with <br> tags
      const formattedMessage = message.replace(/\n/g, '<br><br>');
      messageElement.innerHTML = formattedMessage;
      
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Optionally, send message on Enter key press
    document.getElementById('userInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>